/**
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 *  MAIN.JS - Orchestrateur principal
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 */

(function () {
  "use strict";

  // Variables globales
  let SESSION_ID = null;

  /**
   * Initialisation de l'application
   */
  function init() {
    // V√©rifier les d√©pendances
    const requiredModules = ["UI", "API", "SessionManager", "BookingManager"];
    const missing = requiredModules.filter((mod) => !window[mod]);

    if (missing.length > 0) {
      console.error("‚ùå Modules manquants:", missing);
      alert("Erreur : Modules JavaScript manquants. Rechargez la page.");
      return;
    }

    // Initialiser l'UI
    UI.init();

    // R√©cup√©rer/cr√©er session
    SESSION_ID = SessionManager.getOrCreateSessionId();
    UI.displaySessionId(SESSION_ID);

    // Initialiser Speech API
    const speechSupported = SpeechManager.init(handleTranscript);

    if (speechSupported) {
      UI.updateStatus(" Pr√™t (micro activ√©)", "success");
    } else {
      UI.updateStatus(" Pr√™t (micro non support√©)", "warning");
    }

    // Event listeners
    setupEventListeners();

    //  Initialiser BookingManager globalement
    window.bookingManagerInstance = new window.BookingManager();

    // Initialiser AgendaManager globalement (pour propositions de suppression)
    if (window.AgendaManager) {
      window.agendaManagerInstance = new window.AgendaManager();
    }

    // Message de bienvenue
    UI.showWelcomeMessage();
  }

  /**
   * Configuration des event listeners
   */
  function setupEventListeners() {
    // Bouton Envoyer
    UI.sendButton.addEventListener("click", handleSendMessage);

    // Touche Entr√©e
    UI.textInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSendMessage();
      }
    });

    // Bouton Microphone
    if (UI.micButton) {
      UI.micButton.addEventListener("click", () => {
        SpeechManager.toggle();
      });
    }

    // Bouton Reset
    const resetBtn = document.getElementById("reset-button");
    if (resetBtn) {
      resetBtn.addEventListener("click", () => {
        SessionManager.reset();
      });
    }

    // Bouton Terminer (pour mode urgence)
    const endBtn = document.getElementById("end-conversation-button");
    if (endBtn) {
      endBtn.addEventListener("click", () => {
        endConversation();
      });
    }

    // finalize-button removed (no automatic finalization button)
  }

  /**
   * Termine la conversation et confirme l'envoi au 114
   */
  async function endConversation() {
    if (window.EMERGENCY_MODE) {
      // D√©sactiver les contr√¥les
      UI.setControlsEnabled(false);

      // Afficher un message de confirmation
      UI.displayMessage(
        "system",
        "üì§ Transmission de la conversation au service d'aide sp√©cialis√© (114)..."
      );

      // Simuler un d√©lai d'envoi
      await new Promise((resolve) => setTimeout(resolve, 2000));

      // Confirmer l'envoi dans le bandeau
      confirmHelpServiceSent();

      // Message de confirmation dans le chat
      UI.displayMessage(
        "system",
        "‚úÖ Votre conversation a √©t√© transmise avec succ√®s au 114. Un professionnel pourra vous contacter si n√©cessaire."
      );

      // Cacher le bouton "Terminer"
      const endBtn = document.getElementById("end-conversation-button");
      if (endBtn) {
        endBtn.style.display = "none";
      }
    } else {
      // Mode normal : simplement reset
      SessionManager.reset();
    }
  }

  /**
   * Gestion envoi message
   */
  async function handleSendMessage() {
    const text = UI.getTextInput();

    if (!text) {
      return;
    }

    await sendTextToBackend(text, {});
  }

  /**
   * Gestion transcription vocale
   */
  async function handleTranscript(transcript) {
    await sendTextToBackend(transcript, {});
  }

  /**
   * Envoi message au backend
   */
  async function sendTextToBackend(text, options = {}) {
    // 1. Afficher message utilisateur
    UI.displayMessage("user", text);
    UI.clearTextInput();

    // 2. D√©sactiver contr√¥les
    UI.setControlsEnabled(false);
    UI.showTypingIndicator();
    UI.updateStatus("‚è≥ Envoi en cours...", "warning");

    try {
      // 3. Appel API via API.sendMessage()
      const result = await API.sendMessage(text, SESSION_ID, options);

      // 4. Masquer indicateur
      UI.hideTypingIndicator();

      // 5. V√©rifier succ√®s
      if (!result || !result.success) {
        const errorMsg = result?.error || CONFIG.MESSAGES.NETWORK_ERROR;
        UI.displayMessage("bot", `‚ùå ${errorMsg}`);
        UI.updateStatus("‚ùå Erreur de r√©ponse", "error");
        UI.setControlsEnabled(true);
        return;
      }

      const data = result.data;
      console.log(" [MAIN] R√©ponse re√ßue:", {
        success: result.success,
        data: data,
        is_emergency: data.is_emergency,
        has_analysis: !!data.analysis,
        awaiting_confirmation: data.analysis?.awaiting_confirmation,
        has_proposals: data.analysis?.proposed_changes?.length > 0,
      });

      // 6. GESTION URGENCE - PRIORIT√â ABSOLUE
      if (data.is_emergency === true) {
        console.log("üö® [MAIN] URGENCE D√âTECT√âE !");

        // Afficher le banner d'urgence en haut de la page
        UI.displayEmergencyMessage(
          "**N'h√©sitez pas √† appeler imm√©diatement :**",
          data.emergency_details || {}
        );

        // Marquer la session en mode urgence
        window.EMERGENCY_MODE = true;
        window.EMERGENCY_LEVEL = data.emergency_details?.level || "CRITICAL";

        // ‚úÖ Continuer le traitement normal (afficher message bot, etc.)
        // La banni√®re reste affich√©e en haut pendant toute la conversation
      }

      // 7. FLUX NORMAL (continue m√™me en cas d'urgence)

      if (data.response) {
        UI.displayMessage("bot", data.response);
      }

      // Afficher les recommandations si pr√©sentes (avec message d'introduction et d√©lai)
      // ‚úÖ CORRECTION : Lire depuis data.recommendations (pas data.analysis_results.recommendations)
      if (data.recommendations && data.recommendations.length > 0) {
        // 1. Afficher d'abord un message d'introduction
        setTimeout(() => {
          const introMessage =
            "‚ú® Sur la base de ce que vous m'avez partag√©, j'ai pr√©par√© des recommandations personnalis√©es pour vous aider. Prenez le temps de les explorer ci-dessous :";
          UI.displayMessage("bot", introMessage);

          // 2. Attendre que l'utilisateur lise le message avant d'afficher les cartes
          setTimeout(() => {
            const recommendationsContainer = document.getElementById(
              "recommendations-container"
            );
            if (recommendationsContainer) {
              // Transformer les recommandations textuelles en composants interactifs
              const formattedRecommendations = data.recommendations.map(
                (reco) => {
                  // Si c'est d√©j√† un objet structur√©, le retourner tel quel
                  if (typeof reco === "object") return reco;

                  // Analyser le texte pour d√©terminer le type appropri√©
                  if (
                    reco.toLowerCase().includes("respiration") ||
                    reco.toLowerCase().includes("respiratoire")
                  ) {
                    return {
                      type: "respiration",
                      titre: "Exercice de respiration",
                      message: reco,
                      breathingSteps: [
                        // √âtapes de respiration par d√©faut
                        { phase: "Inspirez", duration: 4 },
                        { phase: "Retenez", duration: 7 },
                        { phase: "Expirez", duration: 8 },
                      ],
                    };
                  }
                  if (
                    reco.toLowerCase().includes("m√©ditation") ||
                    reco.toLowerCase().includes("meditation")
                  ) {
                    return {
                      type: "meditation",
                      titre: "M√©ditation guid√©e",
                      message: reco,
                      video_url: "https://www.youtube.com/embed/xZeFiXMuYM0", // Vid√©o de m√©ditation par d√©faut
                    };
                  }
                  if (reco.toLowerCase().includes("yoga")) {
                    return {
                      type: "yoga",
                      titre: "Exercice de yoga",
                      message: reco,
                      video_url: "https://www.youtube.com/embed/v7AYKMP6rOE", // Vid√©o de yoga par d√©faut
                    };
                  }
                  if (reco.toLowerCase().includes("gratitude")) {
                    return {
                      type: "gratitude",
                      titre: "Journal de gratitude",
                      message: reco,
                    };
                  }
                  if (
                    reco.toLowerCase().includes("productivit√©") ||
                    reco.toLowerCase().includes("concentration") ||
                    reco.toLowerCase().includes("focus")
                  ) {
                    return {
                      type: "productivite",
                      titre: "Timer Pomodoro",
                      message: reco,
                    };
                  }
                  // Par d√©faut, cr√©er une carte simple
                  return {
                    type: "simple",
                    message: reco,
                  };
                }
              );

              recommendationsContainer.style.display = "block";
              window.RecommendationsManager.renderRecommendations(
                formattedRecommendations
              );
            }
          }, 1500); // Attendre 1.5s avant d'afficher les cartes
        }, 800); // Attendre 800ms avant le message d'introduction
      }

      if (window.EMERGENCY_MODE) {
        UI.updateStatus(`üö® MODE URGENCE - Aide disponible ci-dessus`, "error");
      } else {
        const intentInfo = data.intent || "conversation";
        const confidence = data.confidence
          ? `(${(data.confidence * 100).toFixed(0)}%)`
          : "";
        UI.updateStatus(` ${intentInfo} ${confidence}`, "success");
      }

      // 8. SI ORIENTATION N√âCESSAIRE
      console.log("   ‚Üí needs_booking:", data.needs_booking);
      console.log("   ‚Üí analysis_results:", !!data.analysis_results);

      // Note: Les propositions calendrier sont maintenant affich√©es dans les recommandations
      // via le type "agenda" dans recommendations.js

      // 8b. Orientation (r√©servation)
      if (data.needs_booking && data.slots && data.slots.length > 0) {
        console.log("‚úÖ [MAIN] Cr√©neaux de r√©servation d√©tect√©s ‚Üí Affichage");

        // Attendre 1.5 seconde pour laisser lire la r√©ponse
        setTimeout(() => {
          handleOrientation(data);
        }, 1500);
      } else {
        console.log("‚ÑπÔ∏è [MAIN] Pas de cr√©neaux de r√©servation");
      }
    } catch (error) {
      console.error("‚ùå Erreur sendTextToBackend:", error);
      UI.hideTypingIndicator();
      UI.displayMessage("bot", "‚ùå Une erreur inattendue s'est produite.");
      UI.updateStatus("‚ùå Erreur", "error");
    }

    // 9. R√©activer contr√¥les
    UI.setControlsEnabled(true);
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // FONCTIONS OBSOL√àTES SUPPRIM√âES
  // displayEmergencyMessage() ‚Üí Maintenant dans UI.displayEmergencyMessage()
  // displayEmergencyContacts() ‚Üí Int√©gr√© dans UI.displayEmergencyMessage()
  // playEmergencySound() ‚Üí Optionnel, retir√© pour simplifier
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function showEmergencyBanner() {
    // V√©rifier si bandeau existe d√©j√†
    const existing = document.getElementById("emergency-banner");
    if (existing) {
      console.log("‚ö†Ô∏è [BANNER] Bandeau existe d√©j√†, annulation");
      return;
    }

    const banner = document.createElement("div");
    banner.id = "emergency-banner";
    banner.className = "emergency-banner";
    banner.innerHTML = `
            <span style="font-size: 24px;">üö®</span>
            <span>A contacter en cas d'urgence :  09 72 39 40 50 </span>
            <a href="tel:0972394050" class="emergency-banner-button">
                üìû Appeler maintenant
            </a>
        `;

    // Ins√©rer au d√©but du body
    document.body.insertBefore(banner, document.body.firstChild);
    document.body.classList.add("emergency-mode");
  }

  /**
   * Affiche un bandeau persistant indiquant que la conversation sera transmise au service d'aide
   */
  function showHelpServiceBanner() {
    // V√©rifier si bandeau existe d√©j√†
    const existing = document.getElementById("help-service-banner");
    if (existing) {
      console.log("‚ö†Ô∏è [BANNER] Bandeau service d'aide existe d√©j√†, annulation");
      return;
    }

    const banner = document.createElement("div");
    banner.id = "help-service-banner";
    banner.className = "help-service-banner";
    banner.innerHTML = `
            <span style="font-size: 20px;">üì®</span>
            <span>Cette conversation sera transmise au 114 (service d'aide sp√©cialis√©) √† la fin de la discussion</span>
        `;

    // Ins√©rer apr√®s le bandeau d'urgence si pr√©sent, sinon au d√©but du body
    const emergencyBanner = document.getElementById("emergency-banner");
    if (emergencyBanner && emergencyBanner.nextSibling) {
      document.body.insertBefore(banner, emergencyBanner.nextSibling);
    } else if (emergencyBanner) {
      emergencyBanner.parentNode.insertBefore(
        banner,
        emergencyBanner.nextSibling
      );
    } else {
      document.body.insertBefore(banner, document.body.firstChild);
    }
  }

  /**
   * Met √† jour le bandeau pour confirmer l'envoi au 114
   */
  function confirmHelpServiceSent() {
    const banner = document.getElementById("help-service-banner");
    if (banner) {
      banner.classList.add("sent");
      banner.innerHTML = `
            <span style="font-size: 20px;">‚úÖ</span>
            <span>Conversation transmise avec succ√®s au 114 (service d'aide sp√©cialis√©)</span>
        `;
    }
  }

  // Exposer la fonction globalement pour pouvoir l'appeler depuis l'ext√©rieur
  window.confirmHelpServiceSent = confirmHelpServiceSent;

  /**
   * Affiche le bouton "Terminer la conversation" en mode urgence
   */
  function showEndConversationButton() {
    // V√©rifier si le bouton existe d√©j√†
    const existing = document.getElementById("end-conversation-button");
    if (existing) {
      existing.style.display = "block";
      return;
    }

    // Cr√©er le bouton
    const endBtn = document.createElement("button");
    endBtn.id = "end-conversation-button";
    endBtn.className = "end-conversation-button";
    endBtn.textContent = "üì§ Terminer et envoyer au 114";

    // Ajouter l'event listener
    endBtn.addEventListener("click", () => {
      endConversation();
    });

    // Ins√©rer dans la session-header
    const sessionHeader = document.querySelector(".session-header");
    if (sessionHeader) {
      sessionHeader.appendChild(endBtn);
    }
  }

  /**
   *  Formate le texte avec Markdown simple
   */
  function formatMessageWithMarkdown(text) {
    if (!text) return "";

    return (
      text
        // Gras
        .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
        // Italique
        .replace(/\*(.*?)\*/g, "<em>$1</em>")
        // Listes √† puces
        .replace(/^- (.+)$/gm, "<li>$1</li>")
        // Sauts de ligne
        .replace(/\n/g, "<br>")
        // Entourer les listes
        .replace(/(<li>.*<\/li>)/s, "<ul>$1</ul>")
    );
  }

  /**
   * Gestion de l'orientation (r√©servation rendez-vous)
   */
  function handleOrientation(data) {
    console.log("üîç [MAIN] handleOrientation appel√©");
    console.log("   ‚Üí needs_booking:", data.needs_booking);
    console.log("   ‚Üí slots:", data.slots?.length);

    if (data.needs_booking && data.slots && data.slots.length > 0) {
      console.log(`‚úÖ [MAIN] Affichage de ${data.slots.length} cr√©neaux`);
      window.bookingManagerInstance.displaySlots(data.slots);
    } else {
      console.log("‚ÑπÔ∏è [MAIN] Aucun cr√©neau √† afficher");
      window.bookingManagerInstance.hide();
    }
  }

  // D√©marrage au chargement du DOM
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();
